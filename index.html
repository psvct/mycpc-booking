<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>myCPC.online | Booking Portal</title>
  <meta name="description" content="Reserve your Driver CPC course dates. Request an invoice and receive enrolment instructions.">
  <link rel="icon" type="image/png" href="https://psvct.co.uk/wp-content/uploads/2025/11/ChatGPT-Image-Nov-23-2025-04_28_35-PM-1.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
    html{scroll-behavior:smooth;overflow-x:hidden}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;overflow-x:hidden}
    ::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:#f1f5f9}::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:10px}::-webkit-scrollbar-thumb:hover{background:#94a3b8}
    .wrap-safe{overflow-wrap:anywhere;word-break:break-word}
    .cal-grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:.5rem}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">

<header class="sticky top-0 z-50 bg-white/95 backdrop-blur border-b border-slate-200">
  <!-- Fixed Course Times Bar -->
  <div class="bg-slate-900 text-white border-b border-white/10">
    <div class="max-w-7xl mx-auto px-4 py-2 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1">
      <div class="flex flex-wrap items-center gap-x-2 gap-y-1 text-[10px] sm:text-xs font-black uppercase tracking-widest">
        <i data-lucide="clock" class="w-4 h-4 text-blue-300"></i>
        <span class="text-slate-200">Course times:</span>
        <span class="text-blue-200">Full day (7h)</span><span class="text-slate-100">08:00–11:45</span><span class="text-slate-400">+</span><span class="text-slate-100">12:15–16:00</span>
        <span class="hidden sm:inline text-slate-600 mx-1">|</span>
        <span class="text-blue-200">Evening (3.5h)</span><span class="text-slate-100">18:30–22:15</span>
      </div>
      <div class="text-[10px] sm:text-xs font-bold text-slate-300">
        Enrolment opens 15–30 mins before start • Full attendance required
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
    <a href="https://www.my-cpc.online" class="inline-flex items-center gap-2 font-black uppercase italic text-slate-900">
      <span class="bg-blue-600 p-2 rounded-xl text-white"><i data-lucide="arrow-left" class="w-5 h-5"></i></span>
      <span class="hidden sm:inline">Back to myCPC.online</span><span class="sm:hidden">Home</span>
    </a>

    <div class="flex-1 min-w-0">
      <div class="flex items-center gap-2">
        <div class="bg-slate-900 text-white px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-[0.25em]">Booking Portal</div>
        <div id="status-pill" class="text-[10px] font-black uppercase tracking-widest text-slate-500"></div>
      </div>
      <p class="text-xs sm:text-sm font-semibold text-slate-600 mt-1 wrap-safe">
        Select course dates (one seat per course). Request an invoice — we’ll confirm availability and send a payment link.
      </p>
    </div>

    <div class="flex items-center gap-2 shrink-0">
      <button type="button" onclick="openTerms()"
              class="hidden md:inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 font-black uppercase italic text-xs">
        <i data-lucide="file-text" class="w-4 h-4"></i> Terms
      </button>
      <button type="button" onclick="openCart()"
              class="relative inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-black uppercase italic text-xs shadow-lg">
        <i data-lucide="shopping-basket" class="w-4 h-4"></i> Basket
        <span id="cart-count" class="ml-1 inline-flex items-center justify-center w-6 h-6 rounded-full bg-white text-blue-700 text-[11px] font-black">0</span>
      </button>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-4 pb-3">
    <div class="flex flex-col md:flex-row md:items-center gap-3">
      <div class="flex flex-wrap items-center gap-2">
        <button id="view-list-btn" onclick="setView('list')" class="px-4 py-2 rounded-xl font-black uppercase italic text-xs border border-slate-200 bg-white shadow-sm">
          <span class="inline-flex items-center gap-2"><i data-lucide="list" class="w-4 h-4"></i> List</span>
        </button>
        <button id="view-cal-btn" onclick="setView('calendar')" class="px-4 py-2 rounded-xl font-black uppercase italic text-xs border border-slate-200 bg-white">
          <span class="inline-flex items-center gap-2"><i data-lucide="calendar" class="w-4 h-4"></i> Calendar</span>
        </button>
        <div class="hidden md:flex items-center gap-2 ml-2 text-[10px] font-black uppercase tracking-widest text-slate-500">
          <span class="inline-flex items-center gap-1"><span class="w-2.5 h-2.5 rounded-full bg-blue-600"></span> National</span>
          <span class="inline-flex items-center gap-1"><span class="w-2.5 h-2.5 rounded-full bg-purple-600"></span> Pairable (7h)</span>
          <span class="inline-flex items-center gap-1"><span class="w-2.5 h-2.5 rounded-full bg-orange-500"></span> PSV only</span>
        </div>
      </div>

      <div class="flex-1"></div>

      <div class="flex flex-col sm:flex-row gap-2">
        <div class="relative">
          <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
          <input id="search" type="search" placeholder="Search module (e.g. Mod 1, Highway Code)…"
                 class="w-full sm:w-[340px] pl-9 pr-3 py-2 rounded-xl border border-slate-200 bg-white text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-200">
        </div>
        <select id="filter" class="w-full sm:w-[220px] py-2 px-3 rounded-xl border border-slate-200 bg-white text-sm font-semibold">
          <option value="all">All course types</option>
          <option value="mixed">Mixed (HGV/PSV)</option>
          <option value="psv">PSV only</option>
          <option value="pairable">Pairable (7h options)</option>
        </select>
      </div>
    </div>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 py-6">
  <div class="grid lg:grid-cols-3 gap-4 mb-6">
    <div class="lg:col-span-2 bg-white rounded-[28px] border border-slate-200 p-6 shadow-sm">
      <div class="flex items-start gap-3">
        <div class="bg-blue-50 border border-blue-100 p-3 rounded-2xl text-blue-700"><i data-lucide="info" class="w-6 h-6"></i></div>
        <div class="min-w-0">
          <h2 class="font-black uppercase italic tracking-tighter text-xl">How booking works</h2>
          <ul class="mt-2 space-y-1 text-sm font-semibold text-slate-600">
            <li>• Add course dates to your basket (one seat per course).</li>
            <li>• Submit your details to request an invoice and payment link.</li>
            <li>• We’ll confirm the best possible price (including 7h pairings where applicable).</li>
            <li>• You’ll receive enrolment instructions and a student enrolment form.</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="bg-slate-900 text-white rounded-[28px] border border-white/10 p-6 shadow-sm overflow-hidden">
      <div class="flex items-start gap-3">
        <div class="bg-white/10 border border-white/10 p-3 rounded-2xl text-blue-200"><i data-lucide="alert-triangle" class="w-6 h-6"></i></div>
        <div class="min-w-0">
          <h3 class="font-black uppercase italic tracking-tighter text-lg">Courses within 4 days</h3>
          <p class="mt-2 text-sm font-semibold text-slate-200 leading-relaxed">
            If you request a course date running within <strong>4 days</strong>, it may not be confirmed until we contact you.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- List -->
  <section id="list-view" class="space-y-4">
    <div class="flex items-center justify-between">
      <h3 class="font-black uppercase italic tracking-tighter text-2xl">Available dates</h3>
      <button type="button" onclick="refresh()"
              class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 font-black uppercase italic text-xs">
        <i data-lucide="refresh-ccw" class="w-4 h-4"></i> Refresh
      </button>
    </div>
    <div id="list-container" class="grid gap-4"></div>
    <div id="empty-state" class="hidden bg-white rounded-[28px] border border-slate-200 p-10 text-center">
      <div class="mx-auto w-14 h-14 rounded-2xl bg-slate-50 border border-slate-200 flex items-center justify-center text-slate-500">
        <i data-lucide="calendar-x" class="w-7 h-7"></i>
      </div>
      <h4 class="mt-4 font-black uppercase italic tracking-tighter text-xl">No results</h4>
      <p class="mt-2 text-sm font-semibold text-slate-600">Try clearing filters or searching for a different module.</p>
    </div>
  </section>

  <!-- Calendar -->
  <section id="calendar-view" class="hidden space-y-4">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <h3 class="font-black uppercase italic tracking-tighter text-2xl">Calendar</h3>
      <div class="flex items-center gap-2">
        <button onclick="calPrev()" class="px-4 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 font-black uppercase italic text-xs">
          <i data-lucide="chevron-left" class="w-4 h-4"></i> Prev
        </button>
        <div id="cal-label" class="px-4 py-2 rounded-xl bg-slate-900 text-white font-black uppercase italic text-xs tracking-widest"></div>
        <button onclick="calNext()" class="px-4 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 font-black uppercase italic text-xs">
          Next <i data-lucide="chevron-right" class="w-4 h-4"></i>
        </button>
      </div>
    </div>

    <div class="bg-white rounded-[28px] border border-slate-200 p-4 sm:p-6 shadow-sm">
      <div class="cal-grid text-[10px] font-black uppercase tracking-widest text-slate-400 mb-3">
        <div class="text-center">Mon</div><div class="text-center">Tue</div><div class="text-center">Wed</div><div class="text-center">Thu</div><div class="text-center">Fri</div><div class="text-center">Sat</div><div class="text-center">Sun</div>
      </div>
      <div id="cal-grid" class="cal-grid"></div>
    </div>

    <div id="cal-day-panel" class="hidden bg-white rounded-[28px] border border-slate-200 p-6 shadow-sm">
      <div class="flex items-center justify-between gap-3">
        <h4 id="cal-day-title" class="font-black uppercase italic tracking-tighter text-xl"></h4>
        <button onclick="closeDayPanel()" class="px-4 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 font-black uppercase italic text-xs">Close</button>
      </div>
      <div id="cal-day-items" class="mt-4 grid gap-3"></div>
    </div>
  </section>
</main>

<!-- Cart Drawer -->
<div id="cart-drawer" class="fixed inset-0 z-[90] hidden">
  <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeCart()"></div>
  <div class="absolute right-0 top-0 h-full w-full max-w-md bg-white shadow-2xl border-l border-slate-200 flex flex-col">
    <div class="p-5 border-b border-slate-200 flex items-start justify-between gap-3">
      <div>
        <p class="text-[10px] font-black uppercase tracking-[0.25em] text-slate-400">Your basket</p>
        <h3 class="font-black uppercase italic tracking-tighter text-2xl">Selected courses</h3>
        <p class="text-xs font-semibold text-slate-600 mt-1">One seat per course.</p>
      </div>
      <button onclick="closeCart()" class="p-2 rounded-xl hover:bg-slate-100" aria-label="Close basket"><i data-lucide="x" class="w-6 h-6"></i></button>
    </div>

    <div class="p-5 overflow-y-auto flex-1">
      <div id="cart-items" class="grid gap-3"></div>
      <div id="cart-empty" class="hidden text-center py-10">
        <div class="mx-auto w-14 h-14 rounded-2xl bg-slate-50 border border-slate-200 flex items-center justify-center text-slate-500">
          <i data-lucide="shopping-basket" class="w-7 h-7"></i>
        </div>
        <p class="mt-3 font-black uppercase italic tracking-tighter text-lg">Basket empty</p>
        <p class="mt-1 text-sm font-semibold text-slate-600">Add course dates from the list or calendar.</p>
      </div>
      <div class="mt-6 p-4 rounded-2xl border border-slate-200 bg-slate-50">
        <div class="flex items-center justify-between">
          <span class="text-[10px] font-black uppercase tracking-widest text-slate-500">Summary</span>
          <span id="cart-summary" class="text-xs font-black text-slate-900"></span>
        </div>
        <p class="mt-2 text-xs font-semibold text-slate-600 leading-relaxed">
          Your invoice will reflect the best available price (including 7h pairings where applicable).
        </p>
      </div>
    </div>

    <div class="p-5 border-t border-slate-200">
      <button onclick="goCheckout()" id="checkout-btn" disabled
              class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-2xl font-black uppercase italic shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
        Request invoice & enrolment
      </button>
      <button onclick="openTerms()" class="w-full mt-3 border border-slate-200 bg-white hover:bg-slate-50 py-3 rounded-2xl font-black uppercase italic text-xs">
        View Terms & Privacy
      </button>
    </div>
  </div>
</div>

<!-- Checkout Modal -->
<div id="checkout-modal" class="fixed inset-0 z-[100] hidden" aria-hidden="true">
  <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeCheckout()"></div>
  <div class="relative mx-auto max-w-3xl px-4 py-10 h-full flex items-center">
    <div role="dialog" aria-modal="true" aria-labelledby="checkout-title"
         class="w-full bg-white rounded-[28px] shadow-2xl border border-slate-200 overflow-hidden">

      <div class="p-6 border-b border-slate-200 flex items-start justify-between gap-4">
        <div>
          <p class="text-[10px] font-black uppercase tracking-[0.25em] text-slate-400">Step 2</p>
          <h3 id="checkout-title" class="text-xl md:text-2xl font-black uppercase italic tracking-tighter text-slate-900">Request invoice</h3>
          <p class="text-xs font-bold text-slate-500 mt-1">We’ll email a payment link and enrolment instructions.</p>
        </div>
        <button type="button" onclick="closeCheckout()" class="p-2 rounded-xl hover:bg-slate-100" aria-label="Close checkout">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>

      <div class="p-6 md:p-8 max-h-[70vh] overflow-y-auto">
        <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
          <p class="text-xs font-bold text-slate-700"><span class="font-black text-slate-900">Reference:</span> <span id="ref-preview">—</span></p>
          <div id="checkout-selected" class="mt-3 grid gap-2"></div>
        </div>

        <form id="invoice-form" class="mt-6 grid md:grid-cols-2 gap-4">
          <div class="md:col-span-2">
            <label class="text-[10px] font-black uppercase tracking-widest text-slate-500">Your name</label>
            <input required name="name" class="mt-1 w-full px-4 py-3 rounded-2xl border border-slate-200 bg-white font-semibold" placeholder="Full name">
          </div>
          <div>
            <label class="text-[10px] font-black uppercase tracking-widest text-slate-500">Email</label>
            <input required type="email" name="email" class="mt-1 w-full px-4 py-3 rounded-2xl border border-slate-200 bg-white font-semibold" placeholder="you@example.com">
          </div>
          <div>
            <label class="text-[10px] font-black uppercase tracking-widest text-slate-500">Phone</label>
            <input required name="phone" class="mt-1 w-full px-4 py-3 rounded-2xl border border-slate-200 bg-white font-semibold" placeholder="Mobile or landline">
          </div>
          <div>
            <label class="text-[10px] font-black uppercase tracking-widest text-slate-500">Company (optional)</label>
            <input name="company" class="mt-1 w-full px-4 py-3 rounded-2xl border border-slate-200 bg-white font-semibold" placeholder="If booking for an employer">
          </div>
          <div>
            <label class="text-[10px] font-black uppercase tracking-widest text-slate-500">Preferred contact</label>
            <select name="contact_pref" class="mt-1 w-full px-4 py-3 rounded-2xl border border-slate-200 bg-white font-semibold">
              <option>Email</option><option>Phone</option><option>WhatsApp</option>
            </select>
          </div>
          <div class="md:col-span-2">
            <label class="text-[10px] font-black uppercase tracking-widest text-slate-500">Notes (optional)</label>
            <textarea name="notes" rows="3" class="mt-1 w-full px-4 py-3 rounded-2xl border border-slate-200 bg-white font-semibold"
                      placeholder="Anything we should know…"></textarea>
          </div>
          <div class="md:col-span-2">
            <label class="inline-flex items-start gap-3 cursor-pointer">
              <input required type="checkbox" class="mt-1 w-5 h-5 rounded border-slate-300">
              <span class="text-sm font-semibold text-slate-600 leading-relaxed">
                I agree to the <button type="button" onclick="openTerms()" class="text-blue-600 underline font-black">Terms of Booking & Privacy Notice</button>.
              </span>
            </label>
          </div>

          <input type="text" name="botcheck" class="hidden" tabindex="-1" autocomplete="off">

          <div class="md:col-span-2 flex flex-col sm:flex-row gap-3 mt-2">
            <button type="submit" id="submit-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-2xl font-black uppercase italic shadow-lg">Submit request</button>
            <button type="button" onclick="closeCheckout()" class="flex-1 border border-slate-200 bg-white hover:bg-slate-50 py-4 rounded-2xl font-black uppercase italic">Back</button>
          </div>

          <p class="md:col-span-2 text-[11px] font-bold text-slate-500 mt-2">
            Payment is taken via a secure payment link on your invoice.
          </p>
        </form>

        <div id="submit-result" class="hidden mt-6 p-6 rounded-[24px] border border-green-200 bg-green-50">
          <div class="flex items-start gap-3">
            <div class="bg-white border border-green-200 rounded-2xl p-3 text-green-700"><i data-lucide="check-circle-2" class="w-6 h-6"></i></div>
            <div class="min-w-0">
              <h4 class="font-black uppercase italic tracking-tighter text-xl text-green-900">Request received</h4>
              <p class="mt-1 text-sm font-semibold text-green-900/80">Your reference is <span id="ref-final" class="font-black"></span>.</p>
              <p class="mt-2 text-sm font-semibold text-green-900/80 leading-relaxed">
                We’ll email you with an invoice/payment link and enrolment instructions. If any selected course is within 4 days, we’ll contact you first.
              </p>
              <div class="mt-4 flex flex-col sm:flex-row gap-3">
                <a href="https://www.my-cpc.online" class="bg-slate-900 text-white px-6 py-3 rounded-2xl font-black uppercase italic text-xs text-center hover:bg-black">Back to home</a>
                <button type="button" onclick="closeCheckout(true)" class="border border-green-200 bg-white px-6 py-3 rounded-2xl font-black uppercase italic text-xs hover:bg-green-100">Continue browsing</button>
              </div>
            </div>
          </div>
        </div>

      </div>

    </div>
  </div>
</div>

<!-- Terms Modal -->
<div id="terms-modal" class="fixed inset-0 z-[110] hidden" aria-hidden="true">
  <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm" onclick="closeTerms()"></div>
  <div class="relative mx-auto max-w-4xl px-4 py-10 h-full flex items-center">
    <div role="dialog" aria-modal="true" aria-labelledby="terms-title"
         class="w-full bg-white rounded-[28px] shadow-2xl border border-slate-200 overflow-hidden">
      <div class="flex items-start justify-between gap-4 p-6 border-b border-slate-200">
        <div class="space-y-1">
          <p class="text-[10px] font-black uppercase tracking-[0.25em] text-slate-400">Legal</p>
          <h3 id="terms-title" class="text-xl md:text-2xl font-black uppercase italic tracking-tighter text-slate-900">Terms of Booking & Privacy Notice</h3>
          <p class="text-xs font-bold text-slate-500">Paste your formatted Terms + Privacy HTML in this window.</p>
        </div>
        <button type="button" onclick="closeTerms()" class="p-2 rounded-xl hover:bg-slate-100" aria-label="Close Terms">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>
      <div class="p-6 md:p-8 max-h-[70vh] overflow-y-auto">
        <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
          <p class="text-sm font-semibold text-slate-700">Add your Terms of Booking and Privacy Notice here (same content as my-cpc.online).</p>
          <p class="text-sm font-semibold text-slate-700 mt-2">
            Interim link: <a class="text-blue-600 underline font-black" href="https://www.my-cpc.online" target="_blank" rel="noopener noreferrer">my-cpc.online</a>
          </p>
        </div>
      </div>
      <div class="p-6 border-t border-slate-200 flex items-center justify-between">
        <p class="text-[11px] font-bold text-slate-500">Press <span class="font-black">Esc</span> to close.</p>
        <button type="button" onclick="closeTerms()" class="bg-slate-900 text-white px-6 py-3 rounded-2xl font-black uppercase italic text-xs hover:bg-black">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
  // =========================
  // CONFIG — YOU MUST EDIT THESE
  // =========================
  const CONFIG = {
    SUPABASE_URL: "https://jvbitnykgjasweugqgks.supabase.co",
    SUPABASE_ANON_KEY: "sb_publishable_Bu0qel0FaGCSq-r4mE9Xsw_M5O_C-DY",
    SCHEDULE_SOURCE: "public_course_schedule",      // recommended view
    BOOKINGS_TABLE: "booking_requests",
    BOOKING_ITEMS_TABLE: "booking_request_items",
    WEB3FORMS_KEY: "eea7a374-f421-4e9e-ba23-e3d0f67ba412",
    WEB3FORMS_ENDPOINT: "https://api.web3forms.com/submit",
    DAYS_WARNING: 4
  };

  const { createClient } = supabase;
  const sb = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

  let allSessions = [];
  let filteredSessions = [];
  let cart = new Map();
  let viewMode = "list";
  let calMonth = new Date(); calMonth.setDate(1);

  function esc(s){return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;")}
  function fmtDate(d){return new Date(d).toLocaleDateString("en-GB",{weekday:"short",day:"2-digit",month:"short",year:"numeric"})}
  function daysUntil(date){const now=new Date();const t=new Date(date);return Math.ceil((t-now)/(1000*60*60*24))}
  function isWithinWarningWindow(startAt){const d=daysUntil(startAt);return d>=0 && d<=CONFIG.DAYS_WARNING}
  function refCode(){const d=new Date();const y=d.getFullYear();const m=String(d.getMonth()+1).padStart(2,"0");const day=String(d.getDate()).padStart(2,"0");const buf=new Uint32Array(1);crypto.getRandomValues(buf);const rand=String(buf[0]%1000000).padStart(6,"0");return `CPC-${y}${m}${day}-${rand}`}

  function normalizeRow(r){
    return {
      id: r.id,
      start_at: r.start_at,
      end_at: r.end_at,
      module_no: (r.module_no ?? ""),
      module_title: r.module_title,
      block_id: r.block_id || null,
      psv_only: !!r.psv_only,
      delivery: r.delivery || "Online",
      seats_total: r.seats_total ?? null,
      seats_taken: r.seats_taken ?? null
    };
  }

  function buildPairableMap(sessions){
    const map=new Map();
    sessions.forEach(s=>{if(!s.block_id) return; if(!map.has(s.block_id)) map.set(s.block_id,[]); map.get(s.block_id).push(s);});
    for(const [k,arr] of map) arr.sort((a,b)=>new Date(a.start_at)-new Date(b.start_at));
    return map;
  }

  function setView(mode){
    viewMode=mode;
    const list=document.getElementById("list-view");
    const cal=document.getElementById("calendar-view");
    const btnList=document.getElementById("view-list-btn");
    const btnCal=document.getElementById("view-cal-btn");
    if(mode==="calendar"){list.classList.add("hidden");cal.classList.remove("hidden");btnCal.classList.add("shadow-sm");btnList.classList.remove("shadow-sm");}
    else{cal.classList.add("hidden");list.classList.remove("hidden");btnList.classList.add("shadow-sm");btnCal.classList.remove("shadow-sm");}
    renderCalendar(); lucide.createIcons();
  }

  function applyFilters(){
    const q=(document.getElementById("search").value||"").toLowerCase().trim();
    const f=document.getElementById("filter").value;
    const pairMap=buildPairableMap(allSessions);

    filteredSessions=allSessions.filter(s=>{
      const pairable=!!(s.block_id && pairMap.get(s.block_id)?.length>=2);
      const hay=`${s.module_title} ${s.block_id||""} ${s.delivery||""}`.toLowerCase();
      if(q && !hay.includes(q)) return false;
      if(f==="psv") return s.psv_only===true;
      if(f==="mixed") return s.psv_only===false;
      if(f==="pairable") return pairable===true;
      return true;
    });

    renderList();
    renderCalendar();
  }

  function renderList(){
    const container=document.getElementById("list-container");
    const empty=document.getElementById("empty-state");
    container.innerHTML="";
    if(!filteredSessions.length){empty.classList.remove("hidden");return;}
    empty.classList.add("hidden");

    const pairMap=buildPairableMap(filteredSessions);
    const groups=new Map();
    filteredSessions.forEach(s=>{
      const key=new Date(s.start_at).toISOString().slice(0,10);
      if(!groups.has(key)) groups.set(key,[]);
      groups.get(key).push(s);
    });

    Array.from(groups.keys()).sort().forEach(key=>{
      const items=groups.get(key).sort((a,b)=>new Date(a.start_at)-new Date(b.start_at));
      const dateTitle=fmtDate(items[0].start_at);

      const block=document.createElement("div");
      block.className="bg-white rounded-[28px] border border-slate-200 shadow-sm overflow-hidden";
      block.innerHTML=`
        <div class="p-5 border-b border-slate-200 flex items-center justify-between gap-3 flex-wrap">
          <div class="min-w-0">
            <h4 class="font-black uppercase italic tracking-tighter text-xl">${esc(dateTitle)}</h4>
            <p class="text-xs font-semibold text-slate-500">Select course dates below.</p>
          </div>
          <button class="px-4 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 font-black uppercase italic text-[11px]" onclick="openCart()">View basket</button>
        </div>
        <div class="p-5 grid gap-3" id="group-${esc(key)}"></div>
      `;
      container.appendChild(block);
      const inner=block.querySelector(`#group-${CSS.escape(key)}`);

      items.forEach(s=>{
        const pairable=!!(s.block_id && pairMap.get(s.block_id)?.length>=2);
        const warn=isWithinWarningWindow(s.start_at);
        const inCart=cart.has(String(s.id));
        const seatsLeft=(s.seats_total!=null && s.seats_taken!=null) ? Math.max(0,(s.seats_total-s.seats_taken)) : null;
        const leftBorder=pairable ? "border-l-4 border-purple-600" : "border-l-4 border-blue-600";
        const psvRing=s.psv_only ? "ring-1 ring-orange-200" : "";

        const card=document.createElement("div");
        card.className=`p-4 sm:p-5 rounded-[22px] border border-slate-200 bg-slate-50/40 hover:bg-white transition-all ${leftBorder} ${psvRing}`;
        card.innerHTML=`
          <div class="flex flex-col sm:flex-row sm:items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="flex flex-wrap items-center gap-2">
                <span class="text-[10px] font-black uppercase tracking-widest text-slate-500">${esc(fmtDate(s.start_at))}</span>
                ${warn ? `<span class="ml-1 text-[10px] font-black uppercase tracking-widest bg-orange-100 text-orange-700 px-2 py-1 rounded-full">Within ${CONFIG.DAYS_WARNING} days</span>` : ``}
              </div>
              <h5 class="mt-2 font-black uppercase italic tracking-tighter text-lg text-slate-900 wrap-safe">${esc(s.module_title)}</h5>
              <div class="mt-3 flex flex-wrap gap-2">
                ${s.psv_only
                  ? '<span class="px-2.5 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-orange-500 text-white">PSV ONLY</span>'
                  : '<span class="px-2.5 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-emerald-600 text-white">MIXED</span>'}
                ${pairable
                  ? '<span class="px-2.5 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-purple-600 text-white">PAIRABLE (7H)</span>'
                  : '<span class="px-2.5 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-blue-600 text-white">NATIONAL (3.5H)</span>'}
                <span class="px-2.5 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-slate-900 text-white">${esc(String(s.delivery).toUpperCase())}</span>
                ${seatsLeft!=null ? `<span class="px-2.5 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-white border border-slate-200 text-slate-700">Spaces left: ${seatsLeft}</span>` : ``}
              </div>
              ${pairable ? renderPairHint(s, pairMap) : ``}
            </div>

            <div class="flex flex-col gap-2 shrink-0 sm:items-end">
              <button class="${inCart ? "bg-slate-900 hover:bg-black" : "bg-blue-600 hover:bg-blue-700"} text-white px-5 py-3 rounded-2xl font-black uppercase italic text-xs shadow-sm"
                      onclick="toggleCart('${esc(String(s.id))}')">${inCart ? "Remove" : "Add to basket"}</button>
              <button class="border border-slate-200 bg-white hover:bg-slate-50 px-5 py-3 rounded-2xl font-black uppercase italic text-xs" onclick="openCart()">View basket</button>
            </div>
          </div>
        `;
        inner.appendChild(card);
      });
    });

    lucide.createIcons();
  }

  function renderPairHint(s, pairMap){
    const pair=pairMap.get(s.block_id)||[];
    if(pair.length<2) return "";
    const other=pair.find(x=>String(x.id)!==String(s.id));
    if(!other) return "";
    const a=cart.has(String(s.id));
    const b=cart.has(String(other.id));
    const both=a && b;
    const hint=both
      ? "Pairing selected — this will be treated as a 7h (International) option on your invoice."
      : "This date is part of a pairable 7h option. Add both linked modules to request an International (7h) pairing.";
    const action=both ? "" : `
      <button class="mt-2 inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-purple-600 hover:bg-purple-700 text-white font-black uppercase italic text-[11px]"
              onclick="addPair('${esc(String(s.id))}','${esc(String(other.id))}')">Add linked module <i data-lucide="plus" class="w-4 h-4"></i></button>`;
    return `
      <div class="mt-3 p-3 rounded-2xl border border-purple-200 bg-purple-50">
        <p class="text-xs font-bold text-purple-900/80 leading-relaxed">${hint}</p>
        <p class="mt-1 text-[11px] font-black uppercase tracking-widest text-purple-700">
          Linked: ${esc(fmtDate(other.start_at))} — ${esc(other.module_title)}
        </p>
        ${action}
      </div>`;
  }

  function updateCartUI(){
    document.getElementById("cart-count").textContent=String(cart.size);
    const itemsEl=document.getElementById("cart-items");
    const emptyEl=document.getElementById("cart-empty");
    const btn=document.getElementById("checkout-btn");
    const summaryEl=document.getElementById("cart-summary");
    itemsEl.innerHTML="";
    if(cart.size===0){emptyEl.classList.remove("hidden");btn.disabled=true;summaryEl.textContent="0 selected";return;}
    emptyEl.classList.add("hidden");btn.disabled=false;

    const items=Array.from(cart.values()).sort((a,b)=>new Date(a.start_at)-new Date(b.start_at));
    const byBlock=new Map();
    items.forEach(s=>{if(!s.block_id) return; byBlock.set(s.block_id,(byBlock.get(s.block_id)||0)+1);});
    const pairings=Array.from(byBlock.values()).filter(n=>n>=2).length;
    summaryEl.textContent=`${items.length} module${items.length===1?"":"s"} • ${pairings} pairing${pairings===1?"":"s"}`;

    items.forEach(s=>{
      const warn=isWithinWarningWindow(s.start_at);
      const card=document.createElement("div");
      card.className="p-4 rounded-[22px] border border-slate-200 bg-white";
      card.innerHTML=`
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <p class="text-[10px] font-black uppercase tracking-widest text-slate-500">
              ${esc(fmtDate(s.start_at))}
            </p>
            <p class="mt-1 font-black uppercase italic tracking-tighter text-base text-slate-900 wrap-safe">${esc(s.module_title)}</p>
            <div class="mt-2 flex flex-wrap gap-2">
              ${s.psv_only ? '<span class="px-2.5 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-orange-500 text-white">PSV ONLY</span>'
                          : '<span class="px-2.5 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-emerald-600 text-white">MIXED</span>'}
              ${s.block_id ? '<span class="px-2.5 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-purple-600 text-white">PAIRABLE</span>'
                          : '<span class="px-2.5 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-blue-600 text-white">NATIONAL</span>'}
              ${warn ? `<span class="px-2.5 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-orange-100 text-orange-700">Within ${CONFIG.DAYS_WARNING} days</span>` : ``}
            </div>
          </div>
          <button class="p-2 rounded-xl hover:bg-slate-100" onclick="removeFromCart('${esc(String(s.id))}')" aria-label="Remove">
            <i data-lucide="trash-2" class="w-5 h-5 text-slate-500"></i>
          </button>
        </div>`;
      itemsEl.appendChild(card);
    });
    lucide.createIcons();
  }

  function renderCheckoutSelected(){
    const el=document.getElementById("checkout-selected");
    el.innerHTML="";
    Array.from(cart.values()).sort((a,b)=>new Date(a.start_at)-new Date(b.start_at)).forEach(s=>{
      const warn=isWithinWarningWindow(s.start_at);
      const row=document.createElement("div");
      row.className="p-3 rounded-2xl border border-slate-200 bg-white flex items-start justify-between gap-3";
      row.innerHTML=`
        <div class="min-w-0">
          <p class="text-[10px] font-black uppercase tracking-widest text-slate-500">
            ${esc(fmtDate(s.start_at))}
            ${warn ? ` • <span class="text-orange-700">Within ${CONFIG.DAYS_WARNING} days</span>` : ``}
          </p>
          <p class="mt-1 font-black uppercase italic tracking-tighter text-sm text-slate-900 wrap-safe">${esc(s.module_title)}</p>
        </div>
        <button class="p-2 rounded-xl hover:bg-slate-100" onclick="removeFromCart('${esc(String(s.id))}')" aria-label="Remove">
          <i data-lucide="trash-2" class="w-5 h-5 text-slate-500"></i>
        </button>`;
      el.appendChild(row);
    });
    lucide.createIcons();
  }

  function toggleCart(id){
    if(cart.has(id)) cart.delete(id);
    else{const s=allSessions.find(x=>String(x.id)===String(id)); if(s) cart.set(String(s.id),s);}
    updateCartUI(); renderList(); renderCalendar(); renderCheckoutSelected();
  }
  function addPair(aId,bId){
    const a=allSessions.find(x=>String(x.id)===String(aId));
    const b=allSessions.find(x=>String(x.id)===String(bId));
    if(a) cart.set(String(a.id),a);
    if(b) cart.set(String(b.id),b);
    updateCartUI(); renderList(); renderCalendar(); renderCheckoutSelected(); openCart();
  }
  function removeFromCart(id){cart.delete(String(id)); updateCartUI(); renderList(); renderCalendar(); renderCheckoutSelected();}
  function openCart(){document.getElementById("cart-drawer").classList.remove("hidden"); document.body.style.overflow="hidden";}
  function closeCart(){document.getElementById("cart-drawer").classList.add("hidden"); document.body.style.overflow="";}

  function goCheckout(){if(!cart.size) return; closeCart(); renderCheckoutSelected();
    const m=document.getElementById("checkout-modal"); m.classList.remove("hidden"); m.setAttribute("aria-hidden","false"); document.body.style.overflow="hidden"; lucide.createIcons();}
  function closeCheckout(reset=false){
    const m=document.getElementById("checkout-modal"); m.classList.add("hidden"); m.setAttribute("aria-hidden","true"); document.body.style.overflow="";
    if(reset){document.getElementById("submit-result").classList.add("hidden"); document.getElementById("invoice-form").classList.remove("hidden"); document.getElementById("submit-btn").disabled=false;}
  }

  let __termsOpen=false; let __termsPrevFocus=null;
  function openTerms(){
    const modal=document.getElementById("terms-modal"); if(!modal) return;
    __termsPrevFocus=document.activeElement;
    modal.classList.remove("hidden"); modal.setAttribute("aria-hidden","false");
    document.body.style.overflow="hidden"; __termsOpen=true;
    const closeBtn=modal.querySelector('button[aria-label="Close Terms"]'); if(closeBtn) closeBtn.focus();
    lucide.createIcons();
  }
  function closeTerms(){
    const modal=document.getElementById("terms-modal"); if(!modal) return;
    modal.classList.add("hidden"); modal.setAttribute("aria-hidden","true");
    document.body.style.overflow=""; __termsOpen=false;
    if(__termsPrevFocus && __termsPrevFocus.focus) __termsPrevFocus.focus();
  }
  window.addEventListener("keydown",(e)=>{if(__termsOpen && e.key==="Escape"){e.preventDefault(); closeTerms();}});

  function calPrev(){calMonth.setMonth(calMonth.getMonth()-1); renderCalendar();}
  function calNext(){calMonth.setMonth(calMonth.getMonth()+1); renderCalendar();}
  function renderCalendar(){
    if(viewMode!=="calendar") return;
    const label=document.getElementById("cal-label");
    const grid=document.getElementById("cal-grid");
    grid.innerHTML="";
    label.textContent=calMonth.toLocaleDateString("en-GB",{month:"long",year:"numeric"});
    const first=new Date(calMonth);
    const startDay=(first.getDay()+6)%7;
    const daysInMonth=new Date(first.getFullYear(),first.getMonth()+1,0).getDate();

    const byDate=new Map();
    filteredSessions.forEach(s=>{const k=new Date(s.start_at).toISOString().slice(0,10); if(!byDate.has(k)) byDate.set(k,[]); byDate.get(k).push(s);});

    for(let i=0;i<startDay;i++){const cell=document.createElement("div"); cell.className="h-20 sm:h-24 rounded-2xl border border-transparent"; grid.appendChild(cell);}
    for(let day=1;day<=daysInMonth;day++){
      const dt=new Date(first.getFullYear(),first.getMonth(),day);
      const k=dt.toISOString().slice(0,10);
      const items=byDate.get(k)||[];
      const dots=items.slice(0,3).map(s=>{const c=s.psv_only?"bg-orange-500":(s.block_id?"bg-purple-600":"bg-blue-600"); return `<span class="inline-block w-2 h-2 rounded-full ${c}"></span>`;}).join("");
      const cell=document.createElement("button");
      cell.type="button";
      cell.className="h-20 sm:h-24 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 text-left p-3 flex flex-col gap-2 min-w-0";
      cell.onclick=()=>openDayPanel(dt,items);
      cell.innerHTML=`
        <div class="flex items-start justify-between">
          <span class="text-sm font-black text-slate-900">${day}</span>
          ${items.length?`<span class="text-[10px] font-black text-slate-500">${items.length}</span>`:""}
        </div>
        <div class="flex gap-1">${dots}</div>
        <div class="text-[10px] font-bold text-slate-400 truncate">${items.length?esc(items[0].module_title):""}</div>`;
      grid.appendChild(cell);
    }
    lucide.createIcons();
  }

  function openDayPanel(dateObj,items){
    const panel=document.getElementById("cal-day-panel");
    const title=document.getElementById("cal-day-title");
    const list=document.getElementById("cal-day-items");
    list.innerHTML="";
    title.textContent=dateObj.toLocaleDateString("en-GB",{weekday:"long",day:"2-digit",month:"long",year:"numeric"});

    if(!items.length){
      const div=document.createElement("div"); div.className="text-sm font-semibold text-slate-600"; div.textContent="No courses on this date."; list.appendChild(div);
    } else {
      const pairMap=buildPairableMap(filteredSessions);
      items.sort((a,b)=>new Date(a.start_at)-new Date(b.start_at)).forEach(s=>{
        const pairable=!!(s.block_id && pairMap.get(s.block_id)?.length>=2);
        const inCart=cart.has(String(s.id));
        const warn=isWithinWarningWindow(s.start_at);
        const card=document.createElement("div");
        card.className="p-4 rounded-[22px] border border-slate-200 bg-slate-50/40 hover:bg-white transition-all overflow-hidden";
        card.innerHTML=`
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <p class="text-[10px] font-black uppercase tracking-widest text-slate-500">
                Course • ${esc(fmtDate(s.start_at))}${warn?` • <span class="text-orange-700">Within ${CONFIG.DAYS_WARNING} days</span>`:""}
              </p>
              <p class="mt-1 font-black uppercase italic tracking-tighter text-base text-slate-900 wrap-safe">${esc(s.module_title)}</p>
              <div class="mt-2 flex flex-wrap gap-2">
                ${s.psv_only ? '<span class="px-2.5 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-orange-500 text-white">PSV ONLY</span>' :
                             '<span class="px-2.5 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-emerald-600 text-white">MIXED</span>'}
                ${pairable ? '<span class="px-2.5 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-purple-600 text-white">PAIRABLE (7H)</span>' :
                            '<span class="px-2.5 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-blue-600 text-white">NATIONAL</span>'}
              </div>
            </div>
            <button class="${inCart?"bg-slate-900 hover:bg-black":"bg-blue-600 hover:bg-blue-700"} text-white px-4 py-2 rounded-2xl font-black uppercase italic text-xs"
                    onclick="toggleCart('${esc(String(s.id))}')">${inCart?"Remove":"Add"}</button>
          </div>`;
        list.appendChild(card);
      });
    }

    panel.classList.remove("hidden");
    panel.scrollIntoView({behavior:"smooth",block:"start"});
    lucide.createIcons();
  }
  function closeDayPanel(){document.getElementById("cal-day-panel").classList.add("hidden");}

  async function submitRequest(formEl){
    const submitBtn=document.getElementById("submit-btn");
    submitBtn.disabled=true;

    const reference=refCode();
    document.getElementById("ref-preview").textContent=reference;

    const fd=new FormData(formEl);
    const booker={
      name:String(fd.get("name")||"").trim(),
      email:String(fd.get("email")||"").trim(),
      phone:String(fd.get("phone")||"").trim(),
      company:String(fd.get("company")||"").trim(),
      contact_pref:String(fd.get("contact_pref")||"Email").trim(),
      notes:String(fd.get("notes")||"").trim(),
    };

    const items=Array.from(cart.values()).sort((a,b)=>new Date(a.start_at)-new Date(b.start_at));
    const itemsPayload=items.map(s=>({
      session_id:s.id,module_no:s.module_no,module_title:s.module_title,start_at:s.start_at,end_at:s.end_at,
      block_id:s.block_id,psv_only:s.psv_only,delivery:s.delivery,within_4_days:isWithinWarningWindow(s.start_at)
    }));

    const byBlock=new Map();
    itemsPayload.forEach(i=>{if(!i.block_id) return; byBlock.set(i.block_id,(byBlock.get(i.block_id)||0)+1);});
    const pairings=Array.from(byBlock.entries()).filter(([_,n])=>n>=2).map(([bid])=>bid);

// Add an explicit CPC type label per selected item for emails / storage
const itemsPayload2 = itemsPayload.map(i => ({
  ...i,
  cpc_type: (i.block_id && pairings.includes(i.block_id)) ? "International (7h)" : "National (3.5h)"
}));

    let booking_id=null;
    try{
      const {data:bookingData,error:bookingErr}=await sb.from(CONFIG.BOOKINGS_TABLE).insert([{
        reference,
        booker_name:booker.name, booker_email:booker.email, booker_phone:booker.phone,
        company:booker.company||null, contact_pref:booker.contact_pref, notes:booker.notes||null,
        pairings, status:"requested", source:"booking.my-cpc.online"
      }]).select().single();
      if(bookingErr) throw bookingErr;
      booking_id=bookingData?.id;

      const itemsInsert=itemsPayload2.map(i=>({...i,booking_id}));
      const {error:itemsErr}=await sb.from(CONFIG.BOOKING_ITEMS_TABLE).insert(itemsInsert);
      if(itemsErr) throw itemsErr;
    } catch(err){
      console.error("Supabase insert failed:",err);
      // continue to email so you still receive it
    }

    try{
      const emailPayload={
        access_key:CONFIG.WEB3FORMS_KEY,
        subject:`New CPC booking request — ${reference}`,
        from_name:"myCPC.online Booking Portal",
        replyto:booker.email,
        reference,
        booking_id:booking_id||"",
        name:booker.name,email:booker.email,phone:booker.phone,company:booker.company||"",
        contact_pref:booker.contact_pref,notes:booker.notes||"",
        summary_modules_count:String(itemsPayload2.length),
        summary_pairings_blocks:pairings.join(", ")||"None",
        has_within_4_days:itemsPayload2.some(i=>i.within_4_days)?"YES":"NO",
        courses_json:JSON.stringify(itemsPayload2,null,2),
        portal_url:location.href
      };

      const res=await fetch(CONFIG.WEB3FORMS_ENDPOINT,{method:"POST",headers:{"Content-Type":"application/json","Accept":"application/json"},body:JSON.stringify(emailPayload)});
      const json=await res.json();
      if(!json.success) throw new Error(json.message||"Web3Forms failed");
    } catch(err){
      console.error("Web3Forms failed:",err);
      alert("We couldn't send your request right now. Please email info@my-cpc.online with your selected dates.");
      submitBtn.disabled=false;
      return;
    }

    document.getElementById("ref-final").textContent=reference;
    document.getElementById("invoice-form").classList.add("hidden");
    document.getElementById("submit-result").classList.remove("hidden");

    cart.clear();
    updateCartUI(); renderList(); renderCalendar();
  }

  async function refresh(){
    const status=document.getElementById("status-pill");
    status.textContent="Loading…";
    const nowISO=new Date(Date.now()-24*60*60*1000).toISOString();
    const {data,error}=await sb.from(CONFIG.SCHEDULE_SOURCE).select("*").gte("start_at",nowISO).order("start_at",{ascending:true});
    if(error){console.error(error);status.textContent="Schedule unavailable";alert("Could not load the schedule. Check Supabase URL/key and view/table name.");return;}
    allSessions=(data||[]).map(normalizeRow);
    filteredSessions=[...allSessions];
    status.textContent=`${allSessions.length} dates loaded`;
    applyFilters(); updateCartUI(); renderCalendar(); lucide.createIcons();
  }

  window.addEventListener("load",()=>{
    document.getElementById("status-pill").textContent=(CONFIG.SUPABASE_URL.includes("supabase.co") && CONFIG.SUPABASE_ANON_KEY.length>10) ? "" : "CONFIG NOT SET";
    document.getElementById("search").addEventListener("input",applyFilters);
    document.getElementById("filter").addEventListener("change",applyFilters);
    document.getElementById("invoice-form").addEventListener("submit",async (e)=>{e.preventDefault(); await submitRequest(e.target);});
    setView("list");
    lucide.createIcons();
    refresh();
  });
</script>

</body>
</html>
