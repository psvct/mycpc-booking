<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver CPC Booking Portal | myCPC.online</title>

    <!-- GOOGLE ANALYTICS (GA4) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1MQZE671GK"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-1MQZE671GK');
    </script>

    <!-- META PIXEL -->
    <script>
      !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
      n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
      document,'script','https://connect.facebook.net/en_US/fbevents.js');
      fbq('init', '1937159790533296');
      fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=1937159790533296&ev=PageView&noscript=1"/></noscript>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .decision-card { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); border-width: 2px; }
        .decision-selected { border-color: #2563eb !important; background-color: #eff6ff; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .sticky-checkout { position: fixed; top: 0; left: 0; right: 0; z-index: 100; transform: translateY(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); backdrop-filter: blur(12px); background-color: rgba(15, 23, 42, 0.8); }
        .sticky-checkout.visible { transform: translateY(0); }
        .input-error { border-color: #ef4444 !important; background-color: rgba(239, 68, 68, 0.05) !important; }
        .hp-field { display: none; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-24 text-left">

    <!-- Sticky Checkout Bar -->
    <div id="sticky-bar" class="sticky-checkout text-white shadow-2xl px-6 py-4 flex justify-between items-center border-b border-white/10">
        <div class="flex items-center gap-4">
            <div class="bg-blue-600 p-2.5 rounded-xl shadow-lg"><i data-lucide="shopping-cart" class="w-5 h-5 text-white"></i></div>
            <div>
                <div id="sticky-count" class="text-[10px] font-black uppercase text-blue-300 mb-1 leading-none tracking-widest">0 Seats Selected</div>
                <div id="sticky-price" class="text-xl font-black italic">£0.00</div>
            </div>
        </div>
        <button onclick="window.handleStickyAction()" id="sticky-action-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3.5 rounded-2xl font-black text-xs uppercase shadow-lg transition-all active:scale-95">Review Order</button>
    </div>

    <div class="max-w-3xl mx-auto p-4 flex flex-col min-h-screen">
        <!-- Brand Header -->
        <header class="py-6 flex items-center justify-between border-b mb-8 bg-white rounded-b-[32px] px-8 shadow-sm border-slate-100">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-xl shadow-lg"><i data-lucide="award" class="text-white w-6 h-6"></i></div>
                <div>
                    <h1 class="text-xl font-black uppercase italic tracking-tight leading-none mb-1">MyCPC<span class="text-blue-600">.online</span></h1>
                    <p class="text-[9px] text-slate-400 font-black uppercase italic tracking-widest">JAUPT Centre AC02237</p>
                </div>
            </div>
            <div class="bg-slate-100 px-4 py-2.5 rounded-2xl flex items-center gap-2 border border-slate-200 text-blue-600 shadow-inner">
                <i data-lucide="shopping-basket" class="w-5 h-5"></i>
                <span id="basket-count" class="font-black text-lg tabular-nums">0</span>
            </div>
        </header>

        <!-- Step 1: Pathway Selection -->
        <div id="step-pathway" class="animate-in space-y-6">
            <div class="text-center py-8">
                <h2 class="text-3xl font-black uppercase italic tracking-tighter text-slate-800">Booking Portal</h2>
                <p class="text-slate-400 font-bold text-xs uppercase tracking-[0.2em] mt-2">Which CPC course are you looking for?</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="window.selectInitialPathway('national')" class="bg-white p-12 rounded-[48px] border-2 border-transparent hover:border-blue-600 shadow-sm transition-all group text-center active:scale-95">
                    <i data-lucide="zap" class="w-16 h-16 text-blue-600 mx-auto mb-6 group-hover:scale-110 transition-transform"></i>
                    <h3 class="font-black text-2xl uppercase italic text-slate-800">National CPC</h3>
                    <p class="text-[10px] text-slate-400 mt-2 font-bold uppercase tracking-widest">3.5 Hour Standalone Module</p>
                    <div class="mt-4 text-blue-600 font-black text-lg italic">£21.99</div>
                </button>
                <button onclick="window.selectInitialPathway('international')" class="bg-white p-12 rounded-[48px] border-2 border-transparent hover:border-blue-600 shadow-sm transition-all group text-center active:scale-95">
                    <i data-lucide="layers" class="w-16 h-16 text-blue-600 mx-auto mb-6 group-hover:scale-110 transition-transform"></i>
                    <h3 class="font-black text-2xl uppercase italic text-slate-800">International CPC</h3>
                    <p class="text-[10px] text-slate-400 mt-2 font-bold uppercase tracking-widest">7 Hour Pairing (Full Day or Split Evening)</p>
                    <div class="mt-4 text-blue-600 font-black text-lg italic">£38.99</div>
                </button>
            </div>
        </div>

        <!-- Step 2: Course List -->
        <div id="step-courses" class="hidden animate-in space-y-6">
            <div class="flex items-center justify-between">
                <button onclick="window.goToStep('pathway')" class="text-[10px] font-black flex items-center gap-1.5 uppercase text-blue-600 hover:text-blue-700 transition-colors tracking-widest"><i data-lucide="chevron-left" class="w-3.5 h-3.5"></i> Back</button>
                <div id="pathway-badge" class="px-3 py-1 bg-blue-100 text-blue-600 rounded-full text-[9px] font-black uppercase tracking-widest italic">Default: National</div>
            </div>
            <div id="view-container" class="space-y-3"></div>
        </div>

        <!-- Step 3: Invoicing & Final Review -->
        <div id="step-invoicing" class="hidden animate-in space-y-8">
            <!-- Review Section -->
            <div class="bg-white rounded-[40px] p-8 shadow-sm border border-slate-100">
                <h3 class="text-xl font-black mb-6 uppercase italic tracking-tighter flex items-center gap-2"><i data-lucide="shopping-cart" class="text-blue-600"></i> Review Selections</h3>
                <div id="order-summary-container" class="space-y-3 mb-6">
                    <!-- Summary Items go here -->
                </div>
                <div class="flex justify-between items-center pt-6 border-t border-slate-50">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Current Request Est.</span>
                    <span id="summary-total-price" class="text-2xl font-black text-slate-900 italic">£0.00</span>
                </div>
            </div>

            <!-- Invoicing Form -->
            <div class="bg-slate-900 rounded-[48px] p-10 text-white shadow-2xl border-t-8 border-blue-600">
                <button onclick="window.goToStep('courses')" class="text-[10px] font-black text-blue-400 uppercase mb-8 flex items-center gap-2 hover:text-blue-300 transition-colors tracking-widest"><i data-lucide="chevron-left" class="w-4 h-4"></i> Back to Courses</button>
                <h3 class="text-3xl font-black mb-8 flex items-center gap-4 italic uppercase tracking-tighter text-white"><i data-lucide="file-text" class="text-blue-400"></i> Invoicing Details</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-5">
                    <div class="space-y-1.5">
                        <label class="text-[10px] font-black text-white/30 uppercase ml-3 tracking-widest">Invoice To (Company/Name)</label>
                        <input id="invoice_to" placeholder="e.g. Acme Logistics Ltd" class="w-full bg-white/10 border border-white/20 p-5 rounded-[24px] outline-none text-white focus:border-blue-500 transition-all font-bold">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-[10px] font-black text-white/30 uppercase ml-3 tracking-widest">Lead Contact Email</label>
                        <input id="booker_email" type="email" placeholder="email@company.com" class="w-full bg-white/10 border border-white/20 p-5 rounded-[24px] outline-none text-white focus:border-blue-500 transition-all font-bold">
                    </div>
                </div>
                
                <div class="space-y-1.5 mb-5">
                    <label class="text-[10px] font-black text-white/30 uppercase ml-3 tracking-widest">Billing Address & Postcode</label>
                    <textarea id="billing_address" rows="2" placeholder="Full address for invoice generation..." class="w-full bg-white/10 border border-white/20 p-5 rounded-[24px] outline-none text-white focus:border-blue-500 transition-all font-bold"></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-8">
                    <div class="space-y-1.5">
                        <label class="text-[10px] font-black text-white/30 uppercase ml-3 tracking-widest">Contact Phone</label>
                        <input id="contact_phone" placeholder="07xxx xxxxxx" class="w-full bg-white/10 border border-white/20 p-5 rounded-[24px] outline-none text-white focus:border-blue-500 transition-all font-bold">
                    </div>
                    <div class="bg-white/5 p-5 rounded-[24px] flex items-center justify-between border border-white/10 shadow-inner">
                        <span class="text-[10px] font-black text-white/40 uppercase tracking-widest">Final Total</span>
                        <span id="invoice-step-price" class="text-3xl font-black text-blue-400 italic">£0.00</span>
                    </div>
                </div>

                <!-- Legal Acknowledgments -->
                <div class="space-y-3 mb-10">
                    <label class="flex items-center gap-4 p-4 bg-white/5 rounded-2xl border border-white/10 cursor-pointer hover:bg-white/10 transition-all group">
                        <div class="relative flex items-center">
                            <input type="checkbox" id="marketing_opt_in" class="w-5 h-5 rounded border-white/20 bg-transparent text-blue-600 focus:ring-blue-500 cursor-pointer">
                        </div>
                        <span class="text-xs font-bold text-slate-400 group-hover:text-white transition-colors">I wish to receive marketing updates and course reminders from the PSV Compliance and Training group.</span>
                    </label>

                    <label class="flex items-center gap-4 p-4 bg-white/5 rounded-2xl border border-white/10 cursor-pointer hover:bg-white/10 transition-all group">
                        <div class="relative flex items-center">
                            <input type="checkbox" id="terms_agree" class="w-5 h-5 rounded border-white/20 bg-transparent text-blue-600 focus:ring-blue-500 cursor-pointer">
                        </div>
                        <span class="text-xs font-black uppercase italic text-blue-400 group-hover:text-blue-300 transition-colors">I agree to the Terms & Conditions of booking. *</span>
                    </label>
                </div>

                <div id="validation-error" class="hidden bg-red-500/20 border border-red-500/50 p-6 rounded-[24px] mb-8 flex gap-4 animate-in">
                    <i data-lucide="alert-circle" class="text-red-400 w-6 h-6 shrink-0"></i>
                    <p id="error-text" class="text-xs text-red-100 font-bold leading-relaxed"></p>
                </div>

                <button id="submit-btn" onclick="window.submitBooking()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-6 rounded-[32px] font-black text-2xl shadow-2xl uppercase italic transition-all active:scale-[0.98] border-b-4 border-blue-800">Confirm Booking Request</button>
            </div>
            
            <!-- Rotating Safety Hints & Tips -->
            <div id="safety-tips-container" class="bg-blue-900/10 border border-blue-900/20 p-10 rounded-[48px] flex flex-col sm:flex-row gap-8 items-start shadow-sm mt-8">
                <div class="bg-blue-600 p-4 rounded-3xl shadow-lg shrink-0">
                    <i data-lucide="lightbulb" class="w-10 h-10 text-white"></i>
                </div>
                <div>
                    <h4 class="font-black text-lg uppercase mb-3 italic tracking-tighter text-blue-900 underline underline-offset-4 decoration-blue-200">Professional Hints & Tips</h4>
                    <p id="current-safety-tip" class="text-sm font-bold text-slate-600 leading-relaxed italic animate-in">
                        Loading professional tip...
                    </p>
                </div>
            </div>
            <input type="text" id="hp_field" class="hp-field" tabindex="-1">
        </div>

        <!-- Step 5: Success -->
        <div id="step-success" class="hidden animate-in mt-10 text-center space-y-6 pb-12">
            <div class="bg-white rounded-[60px] shadow-2xl p-16 border border-slate-100 relative overflow-hidden">
                <div class="bg-green-100 p-10 rounded-full inline-block mb-10 text-green-600 shadow-inner"><i data-lucide="check-circle" class="w-20 h-20"></i></div>
                <h2 class="text-4xl font-black text-slate-800 mb-4 uppercase italic tracking-tighter">Request Received</h2>
                <div class="bg-blue-50 border-2 border-dashed border-blue-200 rounded-[32px] p-8 inline-block mb-10 relative group">
                    <p class="text-[10px] font-black text-blue-400 uppercase tracking-[0.3em] mb-3">Booking Reference</p>
                    <p id="booking-ref-display" class="text-3xl font-black tracking-[0.2em] text-blue-900 uppercase">---</p>
                </div>
                <p id="success-txt" class="text-slate-500 mb-12 max-w-sm mx-auto font-bold text-base leading-relaxed italic"></p>
                <button onclick="location.reload();" class="bg-slate-900 hover:bg-black text-white px-12 py-5 rounded-[24px] font-black uppercase text-xs tracking-widest transition-all shadow-xl active:scale-95">Start New Request</button>
            </div>
        </div>
    </div>

    <!-- Selection Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-md z-[110] flex items-center justify-center p-6">
        <div class="bg-white rounded-[50px] w-full max-w-md p-12 shadow-2xl relative animate-in">
            <div id="modal-date" class="text-[10px] font-black text-blue-600 uppercase mb-2 italic tracking-widest">Date</div>
            <h3 id="modal-title" class="text-3xl font-black text-slate-800 mb-10 uppercase italic tracking-tighter">Confirm Pathway</h3>
            <div id="pathway-options" class="space-y-4 mb-10"></div>
            <div class="flex items-center justify-between p-5 bg-slate-50 rounded-[28px] mb-10 border border-slate-200 shadow-inner">
                <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Seats</div>
                <div class="flex items-center gap-6">
                    <button onclick="window.modQty(-1)" class="w-12 h-12 rounded-2xl bg-white border-2 border-slate-100 flex items-center justify-center font-black text-slate-900 hover:bg-slate-50 transition-colors">-</button>
                    <input id="m-qty" type="number" value="1" readonly class="bg-transparent text-center font-black text-2xl w-12 outline-none text-slate-800 tabular-nums">
                    <button onclick="window.modQty(1)" class="w-12 h-12 rounded-2xl bg-white border-2 border-slate-100 flex items-center justify-center font-black text-slate-900 hover:bg-slate-50 transition-colors">+</button>
                </div>
            </div>
            <div class="flex gap-4">
                <button onclick="window.closeModal()" class="flex-1 py-5 rounded-[24px] text-xs font-black text-slate-400 uppercase tracking-widest hover:bg-slate-50 transition-colors">Cancel</button>
                <button onclick="window.confirmAddToBasket()" id="add-to-basket-btn" class="flex-[2] bg-blue-600 text-white px-8 py-5 rounded-[24px] font-black uppercase italic shadow-xl active:scale-95 transition-all">Add to Request</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://jvbitnykgjasweugqgks.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_Bu0qel0FaGCSq-r4mE9Xsw_M5O_C-DY'; 
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const WEB3FORMS_KEY = "eea7a374-f421-4e9e-ba23-e3d0f67ba412";

        let liveCourses = [], basket = [], globalLicense = 'HGV', initialPathway = 'national', isProcessing = false, selectedOption = null, activeModalDateCourses = [];

        const professionalTips = [
            "Children MUST be dropped off on the correct side of the road and MUST be seen entering their home safely before departure.",
            "Vulnerable Road Users (VRUs): Always prioritize the protection of cyclists and pedestrians. Give them the space they deserve.",
            "Freight Integrity: Load security is a commitment to everyone's safety. Double-check your restraints before every journey.",
            "Bridge Strikes are 100% preventable. Always know your vehicle height and plan your route specifically for HGV/PSV access.",
            "Struggling with the tech? Neil and the team offer 1-on-1 support to help you get online with confidence for your training.",
            "Driver Well-being: A tired driver is a dangerous driver. Ensure you take your full breaks as mandated by EU & Domestic rules."
        ];

        function rotateTip() {
            const el = document.getElementById('current-safety-tip');
            if(!el) return;
            const randomTip = professionalTips[Math.floor(Math.random() * professionalTips.length)];
            el.innerText = `"${randomTip}"`;
        }

        function esc(s) { return String(s ?? '').replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#39;'); }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
        
        function goToStep(id) {
            ['pathway', 'sector', 'courses', 'invoicing', 'success'].forEach(s => {
                const el = document.getElementById('step-'+s);
                if(el) el.classList.add('hidden');
            });
            const target = document.getElementById('step-'+id);
            if(target) {
                target.classList.remove('hidden');
                if(id === 'invoicing') rotateTip();
            }
            updateBasket();
            window.scrollTo({top:0, behavior:'smooth'});
        }

        window.selectInitialPathway = (p) => {
            initialPathway = p;
            const badge = document.getElementById('pathway-badge');
            const pathwayText = p === 'national' ? 'National (3.5h)' : 'International (7h)';
            if(badge) badge.innerText = `Default: ${pathwayText}`;
            goToStep('courses');
            render();
        };

        window.setGlobalLicense = (l) => { 
            globalLicense = l; 
            goToStep('courses'); 
            render(); 
        };

        function groupKeyForItem(item) {
            if (!item) return "";
            if (item.pathway !== 'international') return `national:${item.courseId}`;
            return `international:${item.groupId || item.data?.block_id || item.courseId}`;
        }

        function getRosterGroups() {
            const map = new Map();
            basket.forEach(item => {
                const key = groupKeyForItem(item);
                if (!map.has(key)) map.set(key, { key, pathway: item.pathway, qty: 0, items: [] });
                const g = map.get(key);
                g.items.push(item);
                if (item.pathway === 'international') g.qty = Math.max(g.qty, item.qty);
                else g.qty += item.qty;
            });
            return Array.from(map.values());
        }

        window.removeGroup = (key) => {
            basket = basket.filter(item => groupKeyForItem(item) !== key);
            localStorage.setItem('cpc_basket', JSON.stringify(basket));
            updateBasket(); render();
        };

        window.changeGroupQty = (key, delta) => {
            const group = getRosterGroups().find(g => g.key === key);
            if (!group) return;
            const newQty = Math.max(1, Math.min(15, group.qty + delta));
            
            basket.forEach(item => {
                if (groupKeyForItem(item) === key) {
                    item.qty = newQty;
                }
            });
            
            localStorage.setItem('cpc_basket', JSON.stringify(basket));
            updateBasket();
        };

        function updateBasket() {
            const groups = getRosterGroups();
            const totalSeats = groups.reduce((a, g) => a + g.qty, 0);
            const totalCost = groups.reduce((a, g) => a + (g.qty * (g.pathway === 'international' ? 38.99 : 21.99)), 0);
            
            const bCount = document.getElementById('basket-count'); if(bCount) bCount.innerText = totalSeats;
            const sBar = document.getElementById('sticky-bar'); if(sBar) sBar.classList.toggle('visible', !!totalSeats);
            const sPrice = document.getElementById('sticky-price'); if(sPrice) sPrice.innerText = `£${totalCost.toFixed(2)}`;
            const iPrice = document.getElementById('invoice-step-price'); if(iPrice) iPrice.innerText = `£${totalCost.toFixed(2)}`;
            const sumPrice = document.getElementById('summary-total-price'); if(sumPrice) sumPrice.innerText = `£${totalCost.toFixed(2)}`;
            const sCount = document.getElementById('sticky-count'); if(sCount) sCount.innerText = `${totalSeats} Seats Selected`;
            
            const btn = document.getElementById('sticky-action-btn');
            const stepCourses = document.getElementById('step-courses');
            if (btn && stepCourses) {
                btn.innerText = (!stepCourses.classList.contains('hidden')) ? "Review Order" : "Confirm Booking";
            }

            renderOrderSummary(groups);
        }

        function renderOrderSummary(groups) {
            const container = document.getElementById('order-summary-container');
            if (!container) return;
            container.innerHTML = '';

            if (groups.length === 0) {
                container.innerHTML = '<p class="text-slate-400 text-xs font-bold uppercase italic">No courses selected</p>';
                return;
            }

            groups.forEach(g => {
                const itemHtml = `
                <div class="flex items-center justify-between p-5 bg-slate-50 rounded-2xl border border-slate-100 animate-in">
                    <div class="flex-1">
                        <div class="text-[8px] font-black text-blue-600 uppercase italic tracking-widest mb-1">${esc(g.pathway)}</div>
                        <div class="text-xs font-bold text-slate-800 leading-tight">
                            ${g.items.map(it => `${esc(it.data.module_name)} (${esc(it.data.date_label)})`).join('<br>')}
                        </div>
                    </div>
                    <div class="flex items-center gap-4 ml-6">
                        <div class="flex items-center gap-2 bg-white px-2 py-1 rounded-xl border border-slate-200 shadow-sm">
                            <button onclick="window.changeGroupQty('${g.key}', -1)" class="w-7 h-7 flex items-center justify-center font-black text-slate-400 hover:text-blue-600 transition-colors">-</button>
                            <span class="text-xs font-black w-6 text-center tabular-nums">${g.qty}</span>
                            <button onclick="window.changeGroupQty('${g.key}', 1)" class="w-7 h-7 flex items-center justify-center font-black text-slate-400 hover:text-blue-600 transition-colors">+</button>
                        </div>
                        <button onclick="window.removeGroup('${g.key}')" class="text-slate-300 hover:text-red-500 transition-colors active:scale-90">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>`;
                container.innerHTML += itemHtml;
            });
            lucide.createIcons();
        }

        function render() {
            const cont = document.getElementById('view-container'); if(!cont) return; cont.innerHTML = '';
            liveCourses.forEach(x => {
                const keyNat = `national:${x.id}`;
                const keyInt = `international:${x.block_id || x.id}`;
                const groups = getRosterGroups();
                const inBasket = groups.find(g => g.key === keyNat || g.key === keyInt);
                const isFull = x.seats_remaining !== null && x.seats_remaining <= 0;

                cont.innerHTML += `
                <div class="flex items-center gap-3 animate-in">
                    <button onclick="${isFull ? '' : `window.openModal('${x.id}')`}" class="flex-1 p-6 bg-white border-2 rounded-[32px] flex justify-between items-center text-left transition-all ${inBasket ? 'border-blue-600 bg-blue-50 shadow-inner' : 'border-slate-100 hover:border-blue-200'} ${isFull ? 'opacity-50 grayscale cursor-not-allowed' : ''}">
                        <div>
                            <div class="text-[9px] font-black text-slate-400 uppercase leading-none mb-1.5 tracking-widest">${esc(x.date_label)}</div>
                            <div class="font-bold text-slate-800 text-sm uppercase italic tracking-tight">${esc(x.module_name)}</div>
                            <div class="text-[8px] font-black uppercase mt-1.5 ${isFull ? 'text-red-500' : 'text-blue-500'} tracking-tighter">${isFull ? 'SESSION FULL' : `${x.seats_remaining} seats remaining`}</div>
                        </div>
                        ${inBasket ? `<div class="bg-blue-600 text-white text-[10px] font-black px-4 py-2 rounded-xl italic">${inBasket.qty} seats</div>` : `<i data-lucide="plus" class="w-5 h-5 text-slate-200"></i>`}
                    </button>
                    ${inBasket ? `<button onclick="window.removeGroup('${inBasket.key}')" class="p-5 bg-red-50 text-red-400 rounded-3xl hover:bg-red-100 active:scale-90 transition-all"><i data-lucide="trash-2" class="w-5 h-5"></i></button>` : ''}
                </div>`;
            });
            lucide.createIcons();
        }

        window.openModal = (id) => {
            const c = liveCourses.find(x => x.id === id); if(!c) return;
            activeModalDateCourses = liveCourses.filter(x => new Date(x.course_start).toDateString() === new Date(c.course_start).toDateString());
            
            const mDate = document.getElementById('modal-date'); if(mDate) mDate.innerText = c.date_label;
            const mQty = document.getElementById('m-qty'); if(mQty) mQty.value = 1;
            const box = document.getElementById('pathway-options'); box.innerHTML = '';
            
            activeModalDateCourses.forEach(course => {
                const b = document.createElement('button');
                b.className = `w-full p-5 rounded-[24px] border-2 text-left decision-card border-slate-100 mt-2 hover:border-blue-200 transition-all ${initialPathway === 'national' && course.id === id ? 'decision-selected' : ''}`;
                if(initialPathway === 'national' && course.id === id) selectedOption = `single_${course.id}`;
                
                b.onclick = () => { selectedOption = `single_${course.id}`; document.querySelectorAll('.decision-card').forEach(x => x.classList.remove('decision-selected')); b.classList.add('decision-selected'); };
                b.innerHTML = `<div class="flex justify-between font-black uppercase italic tracking-tighter items-center"><div><div class="text-sm text-slate-800 font-bold">${esc(course.module_name)}</div><div class="text-[8px] text-slate-400 tracking-widest uppercase">3.5h Standalone Module</div></div><div class="text-blue-600 text-lg">£21.99</div></div>`;
                box.appendChild(b);
            });

            if (activeModalDateCourses.length > 1 || c.block_id) {
                const blockModules = activeModalDateCourses.length > 1 ? activeModalDateCourses : liveCourses.filter(x => x.block_id === c.block_id);
                const names = blockModules.map(m => m.module_name).join(' & ');
                
                const b = document.createElement('button');
                b.className = `w-full p-5 rounded-[24px] border-2 text-left decision-card border-slate-100 mt-2 hover:border-blue-200 transition-all ${initialPathway === 'international' ? 'decision-selected' : ''}`;
                if(initialPathway === 'international') selectedOption = "combined";
                
                b.onclick = () => { selectedOption = "combined"; document.querySelectorAll('.decision-card').forEach(x => x.classList.remove('decision-selected')); b.classList.add('decision-selected'); };
                b.innerHTML = `
                <div class="flex justify-between font-black uppercase italic tracking-tighter items-center">
                    <div class="flex-1 pr-4">
                        <div class="text-sm text-slate-800 font-bold">International Pairing</div>
                        <div class="text-[8px] text-slate-400 tracking-widest leading-relaxed mt-1">${esc(names)}</div>
                        <div class="text-[7px] text-blue-500 font-bold uppercase mt-1">7h Training Total</div>
                    </div>
                    <div class="text-blue-600 text-lg font-black">£38.99</div>
                </div>`;
                box.appendChild(b);
            }
            
            document.getElementById('modal').classList.remove('hidden');
            lucide.createIcons();
        };

        window.confirmAddToBasket = () => {
            const qInput = document.getElementById('m-qty');
            const q = parseInt(qInput ? qInput.value : '1');
            
            if (selectedOption === 'combined') {
                const anchor = activeModalDateCourses.length ? activeModalDateCourses[0] : null;
                if(!anchor) return;
                const blockModules = activeModalDateCourses.length > 1 ? activeModalDateCourses : liveCourses.filter(x => x.block_id === anchor.block_id);
                const gKey = `international:${blockModules[0].block_id || blockModules[0].id}`;
                basket = basket.filter(item => groupKeyForItem(item) !== gKey);
                blockModules.forEach(c => basket.push({ courseId: c.id, pathway: 'international', qty: q, data: c, groupId: `comb_${blockModules[0].id}` }));
            } else {
                const id = selectedOption.replace('single_', '');
                const c = liveCourses.find(x => x.id === id);
                if(c) {
                    const gKey = `national:${id}`;
                    basket = basket.filter(item => groupKeyForItem(item) !== gKey);
                    basket.push({ courseId: c.id, pathway: 'national', qty: q, data: c });
                }
            }
            localStorage.setItem('cpc_basket', JSON.stringify(basket));
            closeModal(); updateBasket(); render();
        };

        async function submitBooking() {
            if (isProcessing) return;
            const btn = document.getElementById('submit-btn'), errBox = document.getElementById('validation-error'), errText = document.getElementById('error-text');
            if (document.getElementById('hp_field').value) return; 
            
            const em = document.getElementById('booker_email').value, inv = document.getElementById('invoice_to').value, adr = document.getElementById('billing_address').value, ph = document.getElementById('contact_phone').value;
            const mktAgree = document.getElementById('marketing_opt_in').checked;
            const termsAgree = document.getElementById('terms_agree').checked;

            if (!inv.trim() || !em.trim() || !adr.trim()) { 
                errBox.classList.remove('hidden'); 
                errText.innerText = "Please complete all required invoicing fields."; 
                return; 
            }

            if (!termsAgree) {
                errBox.classList.remove('hidden');
                errText.innerText = "You must agree to the Terms & Conditions to proceed.";
                return;
            }

            const groups = getRosterGroups();
            const totalSeats = groups.reduce((a, g) => a + g.qty, 0);
            const totalCost = groups.reduce((a, g) => a + (g.qty * (g.pathway === 'international' ? 38.99 : 21.99)), 0);
            if (totalSeats < 1) return;

            isProcessing = true; btn.disabled = true; btn.innerText = "Processing...";
            const bookingRef = `CPC-${Math.random().toString(36).substring(2, 10).toUpperCase()}`;

            try {
                gtag('event', 'purchase', { transaction_id: bookingRef, value: totalCost, currency: 'GBP' });
                fbq('track', 'Purchase', { value: totalCost, currency: 'GBP' });

                const courseSummary = groups.map(g => {
                    const modulesWithDates = g.items.map(it => `[${it.data.date_label}] ${it.data.module_name}`).join(' & ');
                    return `- ${g.pathway.toUpperCase()}: ${modulesWithDates} (Qty: ${g.qty})`;
                }).join('\n');

                const formData = new FormData(); formData.append("access_key", WEB3FORMS_KEY);
                formData.append("subject", `New Booking [${bookingRef}]: ${inv}`);
                formData.append("message", `
NEW BOOKING REQUEST
REFERENCE: ${bookingRef}
TOTAL SEATS: ${totalSeats}
TOTAL EST: £${totalCost.toFixed(2)}

CLIENT DETAILS
Name: ${inv}
Email: ${em}
Phone: ${ph}
Address: ${adr}

COURSES (DATES & MODULES):
${courseSummary}

ACKNOWLEDGMENTS
T&Cs Accepted: YES
Marketing Opt-In: ${mktAgree ? 'YES' : 'NO'}`);
                
                await fetch("https://api.web3forms.com/submit", { method: "POST", body: formData });

                const roster = [];
                groups.forEach(g => g.items.forEach(it => { 
                    for(let i=0; i<g.qty; i++) {
                        roster.push({ lead_email:em, invoice_to:inv, billing_address:adr, contact_phone:ph, global_license:globalLicense, pathway:g.pathway, course_id:it.courseId, booking_ref:bookingRef, driver_name:'TBA', driver_license:'TBA', status:'pending', marketing_opt_in: mktAgree }); 
                    }
                }));
                await _supabase.from('bookings').insert(roster);

                document.getElementById('booking-ref-display').innerText = bookingRef;
                document.getElementById('success-txt').innerText = `Thank you. A request for £${totalCost.toFixed(2)} has been logged. Neil will review and email your invoice to ${em} within 24 hours.`;
                
                basket = []; localStorage.removeItem('cpc_basket'); updateBasket(); goToStep('success');
            } catch (ex) { isProcessing = false; btn.disabled = false; }
        }

        window.modQty = (d) => { let v = parseInt(document.getElementById('m-qty').value) + d; if(v>0 && v<=15) document.getElementById('m-qty').value = v; };
        window.handleStickyAction = () => { if(!document.getElementById('step-courses').classList.contains('hidden')) goToStep('invoicing'); else submitBooking(); };
        window.goToStep = goToStep;
        window.closeModal = closeModal;

        async function init() {
            const { data } = await _supabase.from('course_availability').select('*').order('course_start', { ascending: true });
            if (data) { 
                liveCourses = data; 
                const saved = JSON.parse(localStorage.getItem('cpc_basket') || '[]'); 
                basket = saved.map(i => { 
                    const l = liveCourses.find(c => c.id === i.courseId); 
                    return l ? { ...i, data: l } : null; 
                }).filter(x => x); 
            }
            updateBasket();
            lucide.createIcons();
        }
        window.addEventListener('load', init);
    </script>
</body>
</html>
